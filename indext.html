<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Cabinet Invoice System</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&family=Moul&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* CSS ášá…á“á¶á”á */
        body { font-family: 'Battambang', sans-serif; background-color: #f0f0f0; margin: 0; padding: 20px; }
        .invoice-container { background-color: white; width: 210mm; min-height: 297mm; margin: 0 auto; padding: 40px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; box-sizing: border-box;}
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .logo-area { width: 100px; height: 100px; background-color: #eee; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #888; position: relative; overflow: hidden; cursor: pointer; }
        .logo-area img { max-width: 100%; max-height: 100%; object-fit: contain; display: none; }
        .logo-area:hover { background-color: #e0e0e0; }
        
        .company-title { text-align: center; flex-grow: 1; }
        /* á–ááŸŒá¢á€áŸ’áŸášáŠá¼á… Logo ášá”áŸáŸ‹á¢áŸ’á“á€ */
        .company-title h1 { font-family: 'Moul', serif; margin: 0; font-size: 24px; color: #000; }
        .invoice-details { text-align: right; font-size: 14px; }

        /* Info */
        .info-section { display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 14px; }
        .customer-info { font-weight: bold; margin-bottom: 15px; font-size: 16px; border-bottom: 1px dotted #ccc; padding-bottom: 5px;}

        /* Description & Blueprint */
        .description-box { margin-bottom: 20px; font-size: 14px; line-height: 1.6; }
        .blueprint-placeholder { width: 100%; height: 250px; border: 2px dashed #ccc; margin: 10px 0; display: flex; align-items: center; justify-content: center; color: #aaa; position: relative; overflow: hidden;}
        .blueprint-placeholder img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; vertical-align: middle; }
        th { background-color: #f9f9f9; font-weight: bold; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        
        /* Inputs for Calculation */
        .calc-input { width: 100%; border: none; text-align: center; font-family: 'Battambang'; font-size: 14px; outline: none; background: transparent; }
        .calc-input:focus { background-color: #eef; }
        .total-cell { font-weight: bold; color: #333; }
        
        /* Footer */
        .payment-info { margin-top: 20px; font-size: 14px; background: #fdfdfd; padding: 10px; border: 1px solid #eee; }
        .signatures { display: flex; justify-content: space-between; margin-top: 50px; text-align: center; }
        .sign-line { width: 200px; border-top: 1px solid black; padding-top: 10px; font-weight: bold; }

        /* Buttons Control Panel */
        .control-panel { position: fixed; bottom: 20px; right: 20px; display: flex; gap: 10px; z-index: 1000; }
        
        .btn { padding: 15px 25px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-family: 'Battambang'; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: 0.3s; }
        .print-btn { background-color: #007bff; }
        .jpg-btn { background-color: #ff9800; }
        .btn:hover { transform: translateY(-2px); }

        .no-print-btn { padding: 8px 15px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-top: 10px; }
        .delete-btn { background-color: #dc3545; color: white; border: none; padding: 2px 8px; cursor: pointer; font-size: 12px; border-radius: 3px;}
        .upload-btn { position: absolute; top: 10px; right: 10px; background: #6c757d; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; }
        #logo-placeholder-text { position: absolute; text-align: center; padding: 5px; }

        /* Hide elements when printing or saving jpg */
        @media print {
            body { background-color: white; padding: 0; }
            .invoice-container { box-shadow: none; margin: 0; width: 100%; }
            .control-panel, .no-print-btn, .delete-btn, .upload-btn, #logo-placeholder-text { display: none !important; }
            .calc-input { font-weight: bold; }
            .logo-area { background-color: transparent; border: none; }
        }
    </style>
</head>
<body>

    <div class="control-panel">
        <button class="btn print-btn" onclick="window.print()">ğŸ–¨ï¸ Print / PDF</button>
        <button class="btn jpg-btn" onclick="saveAsJPG()">ğŸ’¾ Save JPG</button>
    </div>

    <div class="invoice-container" id="invoice-content">
        <div class="header">
            <div class="logo-area" onclick="document.getElementById('logo-upload').click()">
                <span id="logo-placeholder-text">á…á»á…áŠá¾á˜áŸ’á”á¸áŠá¶á€áŸ‹ Logo</span>
                <img id="logo-img" />
                <input type="file" id="logo-upload" accept="image/*" style="display:none" onchange="loadLogo(event)">
            </div>
            <div class="company-title">
                <h1>Mobile Cabinet</h1>
                <div style="font-size: 14px; margin-top: 5px;">áœá·á€áŸ’á€á™á”ááŸ’áš / INVOICE</div>
            </div>
            <div class="invoice-details" contenteditable="true">
                <b>Tel: 070684555</b><br>
                <b>060241555</b>
            </div>
        </div>

        <div class="info-section">
            <div contenteditable="true">
                á¢á¶áŸáŸá™áŠáŸ’á‹á¶á“áŸˆ áŠá¸á¡á¼ááŸá‚áŸ’á˜á¶á“á›áŸá<br>
                á—á¼á˜á·á€áŸ„á€ášáŸ’ášá·á… áŸá„áŸ’á€á¶ááŸ‹áŸáŸ†ášáŸ„á„á€áŸ’ášáŸ„á˜<br>
                áááŸ’áŒá–áŸ„á’á·áŸáŸáŸ‚á“á‡áŸá™ ášá¶á‡á’á¶á“á¸á—áŸ’á“áŸ†á–áŸá‰
            </div>
            <div class="text-right">
                á€á¶á›á”ášá·á…áŸ’á†áŸá‘: <span id="date-today"></span>
            </div>
        </div>

        <div class="customer-info" contenteditable="true">
            áˆáŸ’á˜áŸ„áŸ‡: CHANNIT á›áŸáá‘á¼ášáŸáŸá–áŸ’á‘: ........................
        </div>

        <div class="description-box" contenteditable="true">
            â—» á‡á‰áŸ’á‡á¶áŸ†á„áŸá¶áŸ†á„áŸáŸá„áŸ’á€áŸá¸á€áŸ’á”á¿á„áŸáŸ’ášá‘á¶á”áŸ‹áŸ¢á áŸŠá·á“ á‚áŸ’ášáŸ„á„áŠáŸ‚á€ 100x100 á”á¶ááŠáŸ‚á€ 40x80<br>
            á€áŸ’ášá¶á›á€áŸ’áŠá¶ášá€áŸ’á“á»á„á€áŸ’áá¶ášááŸ á€á˜áŸ’ášá¶áŸáŸ‹ 15á›á¸ [Free á€áŸ†ášá¶á›á€áŸ…áŸáŸŠá¼]<br>
            á€á¶ášášáŸ€á”á…áŸ†á˜á¶á“áŸˆ á‘áŸ’áœá¶ášáŠáŸ‚á€2/á”á„áŸ’á¢á½á…2 áœáŸ‚á„ 2m x 2m / á‡á¾á„á˜áŸ‰á¶áŸáŸŠá¸á“ááŸ’ášá‡á¶á€áŸ‹1<br>
            ğŸ“ á”áŸ’ášá–áŸá“áŸ’á’á—áŸ’á›á¾á„ áŒá¸áŸá„áŸ‹á‘áŸáš1 á€áŸ’á“á»á„áá¶á€2 á–áŸ’ášá¸á—áŸ’á›á¾á„2 á¢áŸ†á–á¼á›á—áŸ’á›á¾á„2 áŸ”<br>
            <b>áŸá˜áŸ’á‚á¶á›áŸ‹áŸˆ á‚áŸ’ášáŸ„á„á–ááŸŒ á”áŸ’ášá•áŸáŸ‡ / á€áŸ†ášá¶á›á€áŸ…áŸáŸŠá¼ á”áŸ’ášá•áŸáŸ‡ / áŸáŸ†á™á¶á”á›áŸ€á“ 0.1m/ á‡á¾á„á€áŸ’ášáŸ„á˜ 0.2m=6áŠá¾á˜..áŸ”</b>
        </div>

        <div class="blueprint-placeholder" id="blueprint-area">
            <span id="bp-text">áŠá¶á€áŸ‹ášá¼á”á—á¶á–á”áŸ’á›á„áŸ‹á‘á¸á“áŸáŸ‡ (Print á á¾á™á‚á¼ášáŠáŸƒ á¬ Upload)</span>
            <img id="preview-img" style="display:none;" />
            <input type="file" id="file-upload" accept="image/*" style="display:none" onchange="loadFile(event)">
            <button class="upload-btn" onclick="document.getElementById('file-upload').click()">ğŸ“· Upload ášá¼á”</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width: 30%;">áˆáŸ’á˜áŸ„áŸ‡á‘áŸ†á“á·á‰</th>
                    <th style="width: 20%;">á‘áŸ†á áŸ†</th>
                    <th style="width: 10%;">á…áŸ†á“á½á“</th>
                    <th style="width: 15%;">áá˜áŸ’á›áŸƒášá¶á™ ($)</th>
                    <th style="width: 15%;">áá˜áŸ’á›áŸƒáŸášá»á” ($)</th>
                    <th style="width: 5%;" class="no-print-btn">á›á»á”</th>
                </tr>
            </thead>
            <tbody id="invoice-items">
                <tr>
                    <td><input type="text" class="calc-input text-left" value="á‘á¼ 1"></td>
                    <td><input type="text" class="calc-input" value="3m x 6m"></td>
                    <td><input type="number" class="calc-input qty" value="1" oninput="calculateTotal()"></td>
                    <td><input type="number" class="calc-input price" value="1650" oninput="calculateTotal()"></td>
                    <td class="total-cell">0.00</td>
                    <td class="no-print-btn"></td>
                </tr>
            </tbody>
        </table>
        
        <button class="no-print-btn" onclick="addRow()">â• á”á“áŸ’ááŸ‚á˜á‘áŸ†á“á·á‰</button>

        <div style="margin-top: 20px;">
            <table style="width: 40%; float: right;">
                <tr>
                    <td class="text-right"><b>áá˜áŸ’á›áŸƒáŸášá»á” (Total):</b></td>
                    <td class="total-cell" id="grand-total">0.00$</td>
                </tr>
                <tr>
                    <td class="text-right">á”áŸ’ášá¶á€áŸ‹á€á€áŸ‹ (Deposit):</td>
                    <td><input type="number" class="calc-input" id="deposit-amt" value="500" oninput="calculateTotal()"></td>
                </tr>
                <tr>
                    <td class="text-right"><b>á”áŸ’ášá¶á€áŸ‹á“áŸ…áŸá›áŸ‹ (Balance):</b></td>
                    <td class="total-cell" id="balance-due" style="color: red; font-size: 18px;">0.00$</td>
                </tr>
            </table>
            <div style="clear: both;"></div>
        </div>

        <div class="payment-info" contenteditable="true">
            <b>á”á‰áŸ’á‡á¶á€áŸ‹áŸ– áá˜áŸ’á›áŸƒáá¶á„á›á¾á˜á·á“á”á¼á€á€á¶ášá”á„áŸ‹á–á“áŸ’á’</b><br>
            á€áŸ†áááŸ‹áŸá˜áŸ’á‚á¶á›áŸ‹á•áŸ’áŸáŸá„áŸ—: ..............................................................
        </div>

        <div class="signatures">
            <div>
                <div class="sign-line" contenteditable="true">á ááŸ’áá›áŸáá¶á¢áŸ’á“á€á›á€áŸ‹</div>
            </div>
            <div>
                <div class="sign-line" contenteditable="true">á ááŸ’áá›áŸáá¶á¢áŸ’á“á€á‘á·á‰</div>
            </div>
        </div>
    </div>

    <script>
        // 1. á€á¶á›á”ášá·á…áŸ’á†áŸá‘ááŸ’á„áŸƒá“áŸáŸ‡
        const today = new Date();
        document.getElementById('date-today').innerText = today.toLocaleDateString('en-GB');

        // 2. á˜á»áá„á¶ášá‚á·áá›á»á™
        function calculateTotal() {
            let rows = document.querySelectorAll('#invoice-items tr');
            let grandTotal = 0;

            rows.forEach(row => {
                let qty = parseFloat(row.querySelector('.qty').value) || 0;
                let price = parseFloat(row.querySelector('.price').value) || 0;
                let total = qty * price;
                row.querySelector('.total-cell').innerText = total.toFixed(2);
                grandTotal += total;
            });

            document.getElementById('grand-total').innerText = grandTotal.toFixed(2) + '$';
            let deposit = parseFloat(document.getElementById('deposit-amt').value) || 0;
            let balance = grandTotal - deposit;
            document.getElementById('balance-due').innerText = balance.toFixed(2) + '$';
        }

        // 3. á˜á»áá„á¶ášá”á“áŸ’ááŸ‚á˜á‡á½áš
        function addRow() {
            let table = document.getElementById('invoice-items');
            let newRow = table.insertRow();
            newRow.innerHTML = `
                <td><input type="text" class="calc-input text-left" placeholder="áˆáŸ’á˜áŸ„áŸ‡á‘áŸ†á“á·á‰"></td>
                <td><input type="text" class="calc-input" placeholder="á‘áŸ†á áŸ†"></td>
                <td><input type="number" class="calc-input qty" value="0" oninput="calculateTotal()"></td>
                <td><input type="number" class="calc-input price" value="0" oninput="calculateTotal()"></td>
                <td class="total-cell">0.00</td>
                <td class="no-print-btn"><button class="delete-btn" onclick="removeRow(this)">âŒ</button></td>
            `;
        }

        // 4. á˜á»áá„á¶ášá›á»á”á‡á½áš
        function removeRow(btn) {
            let row = btn.parentNode.parentNode;
            row.parentNode.removeChild(row);
            calculateTotal();
        }

        // 5. Upload ášá¼á”á—á¶á– á“á·á„ Logo
        var loadFile = function(event) {
            var image = document.getElementById('preview-img');
            image.src = URL.createObjectURL(event.target.files[0]);
            image.style.display = 'block';
            document.getElementById('bp-text').style.display = 'none';
        };

        var loadLogo = function(event) {
            var image = document.getElementById('logo-img');
            image.src = URL.createObjectURL(event.target.files[0]);
            image.style.display = 'block';
            document.getElementById('logo-placeholder-text').style.display = 'none';
        };
        
        // 6. á˜á»áá„á¶áš SAVE JPG ááŸ’á˜á¸
        function saveAsJPG() {
            const element = document.getElementById("invoice-content");
            const btn = document.querySelector(".jpg-btn");
            
            // á”áŸ’áŠá¼ášá¢á€áŸ’áŸášá”áŸŠá¼áá»á„
            const originalText = btn.innerText;
            btn.innerText = "â³ á€áŸ†á–á»á„áŠáŸ†áá¾ášá€á¶áš...";

            // á”áŸ’ášá¾ html2canvas
            html2canvas(element, {
                scale: 2, // á’áŸ’áœá¾á¢áŸ„á™ášá¼á”á…áŸ’á”á¶áŸáŸ‹ (High Resolution)
                useCORS: true,
                backgroundColor: "#ffffff", // á’á¶á“á¶áá¶á•áŸ’á‘áŸƒá€áŸ’ášáŸ„á™á–ááŸŒáŸ
                ignoreElements: (node) => {
                    // á€á»áŸ†á¢áŸ„á™á‡á¶á”áŸ‹á”áŸŠá¼áá»á„áŠáŸ‚á›á˜á·á“á…á„áŸ‹á”á¶á“á“áŸ…á€áŸ’á“á»á„ášá¼á”
                    return node.classList.contains('no-print-btn') || 
                           node.classList.contains('upload-btn') ||
                           node.id === 'logo-placeholder-text';
                }
            }).then(canvas => {
                // á”á„áŸ’á€á¾á Link áŠá¾á˜áŸ’á”á¸ Download
                const link = document.createElement('a');
                link.download = 'MobileCabinet-Invoice-' + Date.now() + '.jpg';
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
                
                // á”áŸ’áŠá¼ášá¢á€áŸ’áŸášá˜á€áŠá¾á˜áœá·á‰
                btn.innerText = originalText;
            }).catch(err => {
                alert("á˜á¶á“á”á‰áŸ’á á¶á–áŸá› Save: " + err);
                btn.innerText = originalText;
            });
        }

        // á áŸ…á˜á»áá„á¶ášá‚á·áá›á»á™áŠáŸ†á”á¼á„
        calculateTotal();
    </script>
</body>
</html>